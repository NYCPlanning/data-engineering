name: ðŸ§ª Tests
run-name: ðŸ§ª Tests (${{ github.event_name }})

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  check_formatting:
    name: Check formatting of files
    runs-on: ubuntu-22.04
    container:
      image: nycplanning/build-base:latest
    steps:
      - uses: actions/checkout@v3

      - name: Check python files
        run: black --diff --color --check .

      - name: Check sql files in products
        run: |
          # TODO: Gradually expand this to cover more products
          sqlfluff lint products/knownprojects/
          sqlfluff lint products/pluto/pluto_build/sql

  check_changes:
    name: Check changed files
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      path_filters: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            template:
              - .github/workflows/tests.yml
              - .github/workflows/build.yml
              - products/template/**
            cbbr:
              - products/cbbr/**
            checkbook:
              - products/checkbook/**
            dcpy:
              - dcpy/**
            qa:
              - apps/qa/**
            zap:
              - .github/workflows/zap_test.yml
              - .github/workflows/zap_build_mapzap.yml
              - .github/workflows/zap_export.yml
              - .github/workflows/zap_single_visible.yml
              - products/zap-opendata/**

  confirm_changes:
    name: Confirm changes to relevant files
    runs-on: ubuntu-22.04
    needs: check_changes
    if: ${{ needs.check_changes.outputs.path_filters != '' && toJson(fromJson(needs.check_changes.outputs.path_filters)) != '[]' }}
    steps:
      - name: Output if files have changed
        run: |
          echo "path filters with changed files: ${{ needs.check_changes.outputs.path_filters }}"

  template:
    needs: confirm_changes
    if: contains(needs.check_changes.outputs.path_filters, 'template')
    uses: ./.github/workflows/template_test.yml
    secrets: inherit
  cbbr:
    needs: confirm_changes
    if: contains(needs.check_changes.outputs.path_filters, 'cbbr')
    uses: ./.github/workflows/cbbr_test.yml
  checkbook:
    needs: confirm_changes
    if: contains(needs.check_changes.outputs.path_filters, 'checkbook')
    uses: ./.github/workflows/checkbook_test.yml
    secrets: inherit
  qa:
    needs: confirm_changes
    if: contains(needs.check_changes.outputs.path_filters, 'qa')
    uses: ./.github/workflows/qa_test.yml
    secrets: inherit
  zap:
    needs: confirm_changes
    if: contains(needs.check_changes.outputs.path_filters, 'zap')
    uses: ./.github/workflows/zap_test.yml
    secrets: inherit
  dcpy:
    needs: confirm_changes
    if: contains(needs.check_changes.outputs.path_filters, 'dcpy')
    uses: ./.github/workflows/dcpy_test.yml
    secrets: inherit
