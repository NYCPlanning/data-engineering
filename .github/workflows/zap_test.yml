name: ZAP - Tests
run-name: Tests (${{ github.event_name }})

on:
  workflow_call:

env:
  ZAP_DOMAIN: ${{ secrets.ZAP_CRM_DOMAIN }}
  TENANT_ID: ${{ secrets.ZAP_CRM_TENANT_ID }}
  CLIENT_ID: ${{ secrets.ZAP_CRM_CLIENT_ID }}
  SECRET: ${{ secrets.ZAP_CRM_SECRET }}
  ZAP_ENGINE: ${{ secrets.SQL_ENGINE_EDM_DATA_SERVER }}/edm-zap
  TEST_SCHEMA_SUFFIX: pr_${{ github.event.pull_request.number || 'workflow_dispatch' }}

jobs:
  branch_unit_tests:
    name: Unit tests
    runs-on: ubuntu-22.04
    container:
      image: nycplanning/dev:latest
    defaults:
      run:
        shell: bash
        working-directory: products/zap-opendata
    steps:
      - uses: actions/checkout@v3

      - name: Run Container Setup
        working-directory: ./
        run: ./bash/docker_container_setup.sh

      - name: Run python unit tests
        run: |
          python3 -m pytest -m "not end_to_end" -s --verbose --verbose --durations=0 --cov .

  branch_integration_tests:
    name: End-to-End tests
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: products/zap-opendata
    container:
      image: nycplanning/dev:latest
    steps:
      - uses: actions/checkout@v3

      - name: Run Container Setup
        working-directory: ./
        run: ./bash/docker_container_setup.sh

      - name: Run python End-to-End tests
        run: |
          echo "ðŸš¨ These tests may take ~5 minutes"
          python3 -m pytest -m "end_to_end" -s --verbose --verbose --durations=0 --cov .

  branch_build_mapzap_tests:
    name: Build MapZAP test run
    uses: ./.github/workflows/zap_build_mapzap.yml
    secrets: inherit
