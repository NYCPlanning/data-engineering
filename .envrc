#!/usr/bin/env bash

# Load all variables from .env file
dotenv .env
watch_file .env

export PROJECT_ROOT_PATH="$PWD"

# Activate Python virtual environment if it exists
if [ -d .venv ]; then
    source_env .venv/bin/activate
    export VIRTUAL_ENV="$PWD/.venv"
    PATH_add .venv/bin
fi

# Convert relative paths to absolute paths based on values from .env
export PRODUCT_METADATA_REPO_PATH="$PWD/${PRODUCT_METADATA_REPO_PATH#./}"
export TEMPLATE_DIR="$PWD/${TEMPLATE_DIR#./}"

# make the binaries available on your path
PATH_add bash/bin

# Set BUILD_ENGINE_SCHEMA to branch name if not on main
# Watch for branch changes
watch_file .git/HEAD
CURRENT_BRANCH=$(git branch --show-current 2>/dev/null)
if [ -n "$CURRENT_BRANCH" ] && [ "$CURRENT_BRANCH" != "main" ]; then
    # Convert to lowercase and replace dashes with underscores
    export BUILD_ENGINE_SCHEMA=$(echo "$CURRENT_BRANCH" | tr '[:upper:]' '[:lower:]' | tr '-' '_')
else # On main branch
    unset BUILD_ENGINE_SCHEMA
fi

export BUILD_ENGINE_SERVER=postgresql://$BUILD_ENGINE_USER:$BUILD_ENGINE_PASSWORD@$BUILD_ENGINE_HOST:$BUILD_ENGINE_PORT
