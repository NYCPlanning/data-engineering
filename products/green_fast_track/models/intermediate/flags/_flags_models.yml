version: 2

models:
- name: int_flags__all
  description: A table with all flags
  columns:
  - name: bbl
    data_type: string
    tests:
    - not_null
  - name: flag_id_field_name
    data_type: string
    tests:
    - not_null
    - dbt_expectations.expect_column_distinct_values_to_equal_set:
        name: int_flags__all__flag_id_field_name__set
        arguments:
          value_set: '{{ dbt_utils.get_column_values( table=ref("variables"), column="flag_id_field_name") }}'
  - name: variable_type
    data_type: string
    tests:
    - not_null
    - dbt_expectations.expect_column_distinct_values_to_equal_set:
        name: int_flags__all__variable_type__set
        arguments:
          value_set: '{{ dbt_utils.get_column_values( table=ref("variables"), column="variable_type") }}'
  - name: variable_id
    data_type: string
    tests:
    - not_null
  - name: distance
    data_type: float
  data_tests:
  - name: int_flags__all__compound_key
    test_name: dbt_utils.unique_combination_of_columns
    arguments:
      combination_of_columns:
      - bbl
      - flag_id_field_name
      - variable_id

- name: int__zoning_districts
  columns:
  - name: bbl
    data_type: string
    tests:
    - not_null
  - name: zd
    data_type: string
  - name: zoning_district_type
    data_type: string
    tests:
    - not_null
    - relationships:
        arguments:
          to: ref('zoning_district_mappings')
          field: zoning_district_type
  data_tests:
  - name: int__zoning_districts_compound_key
    test_name: dbt_utils.unique_combination_of_columns
    arguments:
      combination_of_columns:
      - bbl
      - zd
      - zoning_district_type

- name: int_flags__zoning
  columns:
  - name: bbl
    data_type: string
    tests:
    - not_null
  - name: variable_type
    data_type: string
    tests:
    - not_null
  - name: variable_id
    data_type: string
    tests:
    - not_null
  data_tests:
  - name: int_flags__zoning_compound_key
    test_name: dbt_utils.unique_combination_of_columns
    arguments:
      combination_of_columns:
      - bbl
      - variable_type
      - variable_id

- name: int_flags__edesignation
  description: Flags related to edesignation
  columns:
  - name: bbl
    tests:
    - not_null
  - name: variable_type
    tests:
    - not_null
  - name: variable_id
    tests:
    - not_null

- name: int_flags__dob_natural_resources
  description: Flags from a file provided by DOB
  columns:
  - name: bbl
    tests:
    - not_null
  - name: variable_type
    tests:
    - not_null
  - name: variable_id
    tests:
    - not_null

- name: int_flags__spatial
  description: >-
    A table featuring spatially joined BBLs with buffered variable types,  including
    distances to their raw geometry
  columns:
  - name: bbl
    data_type: string
    tests:
    - not_null
  - name: variable_type
    data_type: string
    tests:
    - not_null
  - name: variable_id
    data_type: string
    tests:
    - not_null
  - name: distance
    data_type: float
    tests:
    - not_null
  data_tests:
  - name: int_flags__spatial_compound_key
    test_name: dbt_utils.unique_combination_of_columns
    arguments:
      combination_of_columns:
      - bbl
      - flag_id_field_name
      - variable_id

- name: test_actual__flags_zoning
  description: Particular lots, their zoning fields, and the actual GFT zoning flag results
  columns:
  - name: lot_label
    tests:
    - not_null
  - name: bbl
    tests:
    - not_null
    - unique
  - name: zonedist1
  - name: zonedist2
  - name: zonedist3
  - name: zonedist4
  - name: Zoning Districts
  data_tests:
  # test zoning flag logic
  - name: equality_flags_zoning
    test_name: dbt_utils.equality
    arguments:
      compare_model: ref('test_expected__flags_zoning')

unit_tests:
  - name: test_zoning_district_type
    description: "Check zoning district parsing"
    model: int__zoning_districts
    given:
      - input: ref('stg__pluto')
        # dict format doesn't work because it tries to do cast(null as USER-DEFINED) as "geom"
        # rows:
        #   - {bbl: 123, zonedist1: M1, zonedist2: NULL, zonedist3: NULL, zonedist4: NULL}
        format: sql
        rows: |
          SELECT
            'simple_m' as bbl,
            'M1' as zonedist1,
            NULL as zonedist2,
            NULL as zonedist3,
            NULL as zonedist4
          UNION ALL
          SELECT
            'simple_low_res' as bbl,
            'R2' as zonedist1,
            NULL as zonedist2,
            NULL as zonedist3,
            NULL as zonedist4
          UNION ALL
          SELECT
            'null_districts' as bbl,
            NULL as zonedist1,
            NULL as zonedist2,
            NULL as zonedist3,
            NULL as zonedist4
          UNION ALL
          SELECT
            'simple_high_res' as bbl,
            'R10' as zonedist1,
            NULL as zonedist2,
            NULL as zonedist3,
            NULL as zonedist4
          UNION ALL
          SELECT
            'multiple_districts' as bbl,
            'M1' as zonedist1,
            'R3' as zonedist2,
            NULL as zonedist3,
            NULL as zonedist4
          UNION ALL
          SELECT
            'multiple_similar' as bbl,
            'M1' as zonedist1,
            'M2' as zonedist2,
            NULL as zonedist3,
            NULL as zonedist4
          UNION ALL
          SELECT
            'multiple_same' as bbl,
            'M1-2/R5B' as zonedist1,
            'M1-2/R6A' as zonedist2,
            NULL as zonedist3,
            NULL as zonedist4
          UNION ALL
          SELECT
            'r12_district' as bbl,
            'M1-8A/R12' as zonedist1,
            'C6-4X' as zonedist2,
            NULL as zonedist3,
            NULL as zonedist4
    expect:
      rows:
        - {bbl: simple_m, zd: M1, zoning_district_type: M}
        - {bbl: simple_low_res, zd: R2, zoning_district_type: R2}
        - {bbl: null_districts, zd: NULL, zoning_district_type: NONE}
        - {bbl: simple_high_res, zd: R10, zoning_district_type: R10}
        - {bbl: multiple_districts, zd: M1, zoning_district_type: M}
        - {bbl: multiple_districts, zd: R3, zoning_district_type: R3}
        - {bbl: multiple_similar, zd: M1, zoning_district_type: M}
        - {bbl: multiple_similar, zd: M2, zoning_district_type: M}
        - {bbl: multiple_same, zd: M1-2, zoning_district_type: M}
        - {bbl: multiple_same, zd: R5B, zoning_district_type: R5}
        - {bbl: multiple_same, zd: R6A, zoning_district_type: R6}
        - {bbl: r12_district, zd: M1-8A, zoning_district_type: M}
        - {bbl: r12_district, zd: R12, zoning_district_type: R12}
        - {bbl: r12_district, zd: C6-4X, zoning_district_type: C}
