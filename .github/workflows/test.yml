name: ðŸ§ª Tests
run-name: ðŸ§ª Tests (${{ github.event_name }})

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # dev_container_tests:
  #   name: Dev container tests
  #   runs-on: ubuntu-22.04
  #   steps:
  #     - uses: actions/checkout@v3
  #     - name: Build and dev container and run a command
  #       uses: devcontainers/ci@v0.3
  #       with:
  #         runCmd: pip list

  check_changes:
    name: Check changed files
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      # Expose matched filters as a job output variable
      sub_directories: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            template:
              - db-template/**
            cbbr:
              - db-cbbr/**

  test_changed_datasets:
    name: Test changed datasets
    needs: check_changes
    if: ${{ needs.check_changes.outputs.sub_directories != '' && toJson(fromJson(needs.check_changes.outputs.sub_directories)) != '[]' }}
    # runs-on: ubuntu-latest
    strategy:
      matrix:
        # Parse JSON array containing names of all matched file change filters
        # e.g. ['template', 'cbbr'] if both sub-directories contains changes
        dataset_name: ${{ fromJSON(needs.check_changes.outputs.sub_directories) }}
    uses: ./.github/workflows/test_dataset.yml
    with:
      dataset_name: ${{ matrix.dataset_name }}
    # steps:
    #   - uses: actions/checkout@v3
    #   # - run: |
    #   #     echo -e "changed datasets raw: ${{ needs.check_changes.outputs.sub_directories }}"
    #   #     echo -e "changed datasets fromJson: ${{ fromJson(needs.check_changes.outputs.sub_directories) }}"
    #   # - id: template
    #   #   if: ${{ matrix.dataset_name }} == 'template'
    #   #   uses: ./.github/workflows/template_test.yml
    #   # - id: cbbr
    #   #   if: ${{ matrix.dataset_name }} == 'cbbr'
    #   #   uses: ./.github/workflows/cbbr_test.yml
    #   # - uses: workflows/test_dataset.yml
    #   - uses: ./.github/actions/test_dataset
    #     with:
    #       dataset_name: ${{ matrix.dataset_name }}
