DROP TABLE IF EXISTS FINAL_DEVDB;
WITH CORR_LISTS AS (
    SELECT
        JOB_NUMBER,
        STRING_AGG(FIELD, '/') AS DCPEDITFIELDS
    FROM CORRECTIONS_APPLIED GROUP BY JOB_NUMBER
)

SELECT DISTINCT ON (MID_DEVDB.JOB_NUMBER)
    MID_DEVDB.JOB_NUMBER,
    MID_DEVDB.JOB_TYPE,
    MID_DEVDB.RESID_FLAG,
    MID_DEVDB.NONRES_FLAG,
    MID_DEVDB.JOB_INACTIVE,
    MID_DEVDB.JOB_STATUS,
    MID_DEVDB.COMPLETE_YEAR,
    MID_DEVDB.COMPLETE_QRTR,
    MID_DEVDB.PERMIT_YEAR,
    MID_DEVDB.PERMIT_QRTR,
    MID_DEVDB.CLASSA_INIT,
    MID_DEVDB.CLASSA_PROP,
    MID_DEVDB.CLASSA_NET,
    DEVDB_HNY_LOOKUP.CLASSA_HNYAFF,
    MID_DEVDB.HOTEL_INIT,
    MID_DEVDB.HOTEL_PROP,
    MID_DEVDB.OTHERB_INIT,
    MID_DEVDB.OTHERB_PROP,
    MID_DEVDB.CO_LATEST_UNITS AS UNITS_CO,
    MID_DEVDB.OCC_INITIAL,
    MID_DEVDB.OCC_PROPOSED,
    MID_DEVDB.BLDG_CLASS,
    MID_DEVDB.JOB_DESC,
    MID_DEVDB.DESC_OTHER,
    MID_DEVDB.DATE_FILED,
    MID_DEVDB.DATE_STATUSD,
    MID_DEVDB.DATE_STATUSP,
    MID_DEVDB.DATE_PERMITTD,
    MID_DEVDB.DATE_STATUSR,
    MID_DEVDB.DATE_STATUSX,
    MID_DEVDB.DATE_LASTUPDT,
    MID_DEVDB.DATE_COMPLETE,
    MID_DEVDB.ZONINGDIST1,
    MID_DEVDB.ZONINGDIST2,
    MID_DEVDB.ZONINGDIST3,
    MID_DEVDB.SPECIALDIST1,
    MID_DEVDB.SPECIALDIST2,
    MID_DEVDB.LANDMARK,
    MID_DEVDB.ZSF_INIT,
    MID_DEVDB.ZSF_PROP,
    MID_DEVDB.ZUG_INIT,
    MID_DEVDB.ZUG_PROP,
    MID_DEVDB.ZSFR_PROP,
    MID_DEVDB.ZSFC_PROP,
    MID_DEVDB.ZSFCF_PROP,
    MID_DEVDB.ZSFM_PROP,
    MID_DEVDB.PRKNGPROP,
    MID_DEVDB.STORIES_INIT,
    MID_DEVDB.STORIES_PROP,
    MID_DEVDB.HEIGHT_INIT,
    MID_DEVDB.HEIGHT_PROP,
    MID_DEVDB.CONSTRUCTNSF,
    MID_DEVDB.ENLARGEMENT,
    MID_DEVDB.ENLARGEMENTSF,
    MID_DEVDB.COSTESTIMATE,
    MID_DEVDB.LOFTBOARDCERT,
    MID_DEVDB.EDESIGNATION,
    MID_DEVDB.CURBCUT,
    MID_DEVDB.TRACTHOMES,
    MID_DEVDB.OWNERSHIP,
    MID_DEVDB.OWNER_NAME,
    MID_DEVDB.OWNER_BIZNM,
    MID_DEVDB.OWNER_ADDRESS,
    MID_DEVDB.OWNER_ZIPCODE,
    MID_DEVDB.OWNER_PHONE,
    PLUTO_DEVDB.PLUTO_UNITRES,
    PLUTO_DEVDB.PLUTO_BLDGSF,
    PLUTO_DEVDB.PLUTO_COMSF,
    PLUTO_DEVDB.PLUTO_OFFCSF,
    PLUTO_DEVDB.PLUTO_RETLSF,
    PLUTO_DEVDB.PLUTO_RESSF,
    PLUTO_DEVDB.PLUTO_YRBUILT,
    PLUTO_DEVDB.PLUTO_YRALT1,
    PLUTO_DEVDB.PLUTO_YRALT2,
    PLUTO_DEVDB.PLUTO_HISTDST,
    PLUTO_DEVDB.PLUTO_LANDMK,
    PLUTO_DEVDB.PLUTO_BLDGCLS,
    PLUTO_DEVDB.PLUTO_LANDUSE,
    PLUTO_DEVDB.PLUTO_OWNER,
    PLUTO_DEVDB.PLUTO_OWNTYPE,
    PLUTO_DEVDB.PLUTO_CONDO,
    PLUTO_DEVDB.PLUTO_BLDGS,
    PLUTO_DEVDB.PLUTO_FLOORS,
    PLUTO_DEVDB.PLUTO_VERSION,
    MID_DEVDB.GEO_CB2020 AS CENBLOCK2020,
    MID_DEVDB.GEO_CT2020 AS CENTRACT2020,
    MID_DEVDB.BCTCB2020,
    MID_DEVDB.BCT2020,
    MID_DEVDB.GEO_NTA2020 AS NTA2020,
    MID_DEVDB.GEO_NTANAME2020 AS NTANAME2020,
    MID_DEVDB.GEO_CDTA2020 AS CDTA2020,
    MID_DEVDB.GEO_CDTANAME2020 AS CDTANAME2020,
    MID_DEVDB.GEO_CD AS COMUNITYDIST,
    MID_DEVDB.GEO_COUNCIL AS COUNCILDIST,
    MID_DEVDB.GEO_SCHOOLSUBDIST AS SCHOOLSUBDIST,
    MID_DEVDB.GEO_CSD AS SCHOOLCOMMNTY,
    MID_DEVDB.GEO_SCHOOLELMNTRY AS SCHOOLELMNTRY,
    MID_DEVDB.GEO_SCHOOLMIDDLE AS SCHOOLMIDDLE,
    MID_DEVDB.GEO_FIRECOMPANY AS FIRECOMPANY,
    MID_DEVDB.GEO_FIREBATTALION AS FIREBATTALION,
    MID_DEVDB.GEO_FIREDIVISION AS FIREDIVISION,
    MID_DEVDB.GEO_POLICEPRCT AS POLICEPRECNCT,
    PLUTO_DEVDB.PLUTO_FIRM07,
    PLUTO_DEVDB.PLUTO_PFIRM15,
    MID_DEVDB.LATITUDE,
    MID_DEVDB.LONGITUDE,
    MID_DEVDB.DATASOURCE,
    MID_DEVDB.GEOMSOURCE,
    --    depdrainarea,
    --    deppumpstatn,
    CORR_LISTS.DCPEDITFIELDS,
    DEVDB_HNY_LOOKUP.HNY_ID,
    DEVDB_HNY_LOOKUP.HNY_JOBRELATE,
    COALESCE(MID_DEVDB.GEO_BORO, MID_DEVDB.BORO) AS BORO,
    COALESCE(MID_DEVDB.GEO_BIN, MID_DEVDB.BIN) AS BIN,
    COALESCE(MID_DEVDB.GEO_BBL, MID_DEVDB.BBL) AS BBL,
    REGEXP_REPLACE(COALESCE(MID_DEVDB.GEO_ADDRESS_NUMBR, MID_DEVDB.ADDRESS_NUMBR), '[\s]{2,}', ' ', 'g') AS ADDRESS_NUMBR,
    REGEXP_REPLACE(COALESCE(MID_DEVDB.GEO_ADDRESS_STREET, MID_DEVDB.ADDRESS_STREET), '[\s]{2,}', ' ', 'g') AS ADDRESS_ST,
    REGEXP_REPLACE(
        COALESCE(MID_DEVDB.GEO_ADDRESS_NUMBR, MID_DEVDB.ADDRESS_NUMBR)
        || ' ' || COALESCE(MID_DEVDB.GEO_ADDRESS_STREET, MID_DEVDB.ADDRESS_STREET), '[\s]{2,}', ' ', 'g'
    ) AS ADDRESS,
    : 'VERSION' AS VERSION
INTO FINAL_DEVDB
FROM MID_DEVDB
LEFT JOIN DEVDB_HNY_LOOKUP ON MID_DEVDB.JOB_NUMBER = DEVDB_HNY_LOOKUP.JOB_NUMBER
LEFT JOIN PLUTO_DEVDB ON MID_DEVDB.JOB_NUMBER = PLUTO_DEVDB.JOB_NUMBER
LEFT JOIN CORR_LISTS ON MID_DEVDB.JOB_NUMBER = CORR_LISTS.JOB_NUMBER;
